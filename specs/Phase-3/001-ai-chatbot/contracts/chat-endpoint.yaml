openapi: 3.1.0
info:
  title: AI Chatbot Endpoint
  version: 1.0.0
  description: |
    Stateless chat endpoint for AI-powered task management.
    Accepts user messages, processes via OpenAI Agent, executes MCP tools, and returns responses.

servers:
  - url: https://api.yourdomain.com
    description: Production server

paths:
  /api/{user_id}/chat:
    post:
      summary: Send message to AI chatbot
      description: |
        Process user message through AI agent with conversation history.
        Agent interprets intent and executes task operations via MCP tools.
        Stateless: fetches history from DB, processes, stores updates, returns response.
      operationId: chatWithAgent
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Authenticated user ID (must match JWT token user_id)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                conversation_id:
                  type: integer
                  nullable: true
                  description: |
                    Optional: Resume existing conversation.
                    Omit for new conversation.
                  example: 123
                message:
                  type: string
                  minLength: 1
                  maxLength: 10000
                  description: User's message to the AI assistant
                  example: "Add task to buy groceries"
            examples:
              new_conversation:
                summary: Start new conversation
                value:
                  message: "Add task to buy milk"
              resume_conversation:
                summary: Resume existing conversation
                value:
                  conversation_id: 123
                  message: "Show me my tasks"
      responses:
        '200':
          description: Successful response from AI agent
          content:
            application/json:
              schema:
                type: object
                required:
                  - conversation_id
                  - response
                  - tool_calls
                properties:
                  conversation_id:
                    type: integer
                    description: ID of the conversation (new or resumed)
                    example: 123
                  response:
                    type: string
                    description: Natural language response from AI assistant
                    example: "I've added 'Buy milk' to your tasks."
                  tool_calls:
                    type: array
                    description: List of MCP tools executed by agent
                    items:
                      type: object
                      required:
                        - tool_name
                        - parameters
                        - result
                      properties:
                        tool_name:
                          type: string
                          enum: [add_task, list_tasks, complete_task, update_task, delete_task]
                          example: "add_task"
                        parameters:
                          type: object
                          description: Parameters passed to the tool
                          example:
                            user_id: 5
                            title: "Buy milk"
                        result:
                          type: object
                          description: Tool execution result
                          example:
                            task_id: 42
                            title: "Buy milk"
                            completed: false
              examples:
                add_task_success:
                  summary: Task added successfully
                  value:
                    conversation_id: 123
                    response: "I've added 'Buy milk' to your tasks."
                    tool_calls:
                      - tool_name: "add_task"
                        parameters:
                          user_id: 5
                          title: "Buy milk"
                        result:
                          task_id: 42
                          title: "Buy milk"
                          completed: false
                          created_at: "2025-12-30T12:00:00Z"
                list_tasks_success:
                  summary: Tasks listed successfully
                  value:
                    conversation_id: 123
                    response: "You have 2 pending tasks:\n1. Buy milk\n2. Call mom"
                    tool_calls:
                      - tool_name: "list_tasks"
                        parameters:
                          user_id: 5
                          status: "pending"
                        result:
                          tasks:
                            - task_id: 42
                              title: "Buy milk"
                              completed: false
                            - task_id: 43
                              title: "Call mom"
                              completed: false
                          count: 2
        '401':
          description: Unauthorized - Invalid or missing JWT token
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
                    example: "Invalid or expired token"
        '403':
          description: Forbidden - User ID mismatch
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
                    example: "User ID in URL does not match authenticated user"
        '404':
          description: Not Found - Conversation does not exist or belongs to another user
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
                    example: "Conversation not found"
        '422':
          description: Unprocessable Entity - Invalid request body
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: array
                    items:
                      type: object
                      properties:
                        loc:
                          type: array
                          items:
                            type: string
                        msg:
                          type: string
                        type:
                          type: string
              example:
                detail:
                  - loc: ["body", "message"]
                    msg: "field required"
                    type: "value_error.missing"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
                    example: "An error occurred while processing your request. Please try again."

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token from Better Auth login.
        Include in Authorization header: "Bearer <token>"

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        conversation_id:
          type: integer
          nullable: true
        message:
          type: string
          minLength: 1
          maxLength: 10000

    ChatResponse:
      type: object
      required:
        - conversation_id
        - response
        - tool_calls
      properties:
        conversation_id:
          type: integer
        response:
          type: string
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      required:
        - tool_name
        - parameters
        - result
      properties:
        tool_name:
          type: string
          enum: [add_task, list_tasks, complete_task, update_task, delete_task]
        parameters:
          type: object
        result:
          type: object

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
